if(typeof cowebConfig==="undefined")var cowebConfig={};cowebConfig={sessionImpl:cowebConfig.sessionImpl||"coweb/session/BayeuxSession",listenerImpl:cowebConfig.listenerImpl||"coweb/listener/UnmanagedHubListener",collabImpl:cowebConfig.collabImpl||"coweb/collab/UnmanagedHubCollab",debug:cowebConfig.debug||!1,adminUrl:cowebConfig.adminUrl||"/admin",loginUrl:cowebConfig.loginUrl||"/login",logoutUrl:cowebConfig.logoutUrl||"/logout"},define("coweb/main",[cowebConfig.sessionImpl,cowebConfig.listenerImpl,cowebConfig.collabImpl],function(a,b,c){var d=null,e=null,f;typeof console==="undefined"&&(f=function(){},console={},console.error=console.warn=console.log=console.info=console.debug=f);return{VERSION:"0.5",initSession:function(){if(d)return d;d=new a,e=new b,d.init(cowebConfig,e);return d},initCollab:function(a){a=a||{};var b=new c;b.init(a);return b},reset:function(){d&&d.destroy(),d=null}}}),define("coweb/util/Promise",["require","exports","module"],function(){var a=function(){var b,c,d,e,f,g=function(){var a,c,f,g,h=!1,i=function(a){var b=a.promise;return function(a){b.resolve(a)}},j=function(a){var b=g.promise;return function(a){b.fail(a)}};while(b){g=b,b=b.next,a=e?g.errback:g.callback;if(a)try{c=a.call(g.context||this,d);if(c&&typeof c.then==="function"){c.then(i(g),j(g),g.context);continue}f=c===undefined?d:c,c instanceof Error?g.promise.fail(f):g.promise.resolve(f)}catch(k){typeof console!=="undefined"&&console.error&&console.error(k,a),g.promise.fail(k),h=!0}else e?g.promise.fail(d):g.promise.resolve(d)}return h};this.then=function(d,e,h){if(d&&typeof d!=="function"){d=h[d];if(typeof d!=="function")throw new Error("callback must be a function")}if(e&&typeof e!=="function"){e=h[e];if(typeof e!=="function")throw new Error("errback must be a function")}var i={callback:d,errback:e,context:h,promise:new a};b?(c.next=i,c=i):b=c=i,f&&g();return i.promise},this.resolve=function(a){if(f)throw new Error("promise already resolved");f=!0,d=a;return g()},this.fail=function(a){if(f)throw new Error("promise already resolved");f=!0,e=!0,d=a;return g()}};return a}),define("coweb/util/xhr",["coweb/util/Promise"],function(a){var b=function(a,b){if(b)for(var c in b)b.hasOwnProperty(c)&&a.setRequestHeader(c,b[c])};return{send:function(c){var d=new a,e=new XMLHttpRequest;c.xhr=d.xhr=e,e.onreadystatechange=function(a){a=a||window.event;var b=e.readyState;if(b===4){e.onreadystatechange=function(){};var f;try{f=e.status||0}catch(g){f=0}f>=200&&f<300||f===304||f===1223?d.resolve(c):(c.error=new Error("failed loading "+c.url+" status:"+f),d.fail(c))}};try{e.open(c.method,c.url,c.sync!==!0),b(e,c.headers),e.send(c.body||null)}catch(f){c.onError("failed sending xhr to "+c.url,f);throw f}return d}}}),define("org/cometd",["require","exports","module"],function(){typeof dojo!=="undefined"?dojo.provide("org.cometd"):(this.org=this.org||{},org.cometd={}),org.cometd.JSON={},org.cometd.JSON.toJSON=org.cometd.JSON.fromJSON=function(a){throw"Abstract"},org.cometd.Utils={},org.cometd.Utils.isString=function(a){if(a===undefined||a===null)return!1;return typeof a==="string"||a instanceof String},org.cometd.Utils.isArray=function(a){if(a===undefined||a===null)return!1;return a instanceof Array},org.cometd.Utils.inArray=function(a,b){for(var c=0;c<b.length;++c)if(a==b[c])return c;return-1},org.cometd.Utils.setTimeout=function(a,b,c){return setTimeout(function(){try{b()}catch(c){a._debug("Exception invoking timed function",b,c)}},c)},org.cometd.TransportRegistry=function(){var a=[],b={};this.getTransportTypes=function(){return a.slice(0)},this.findTransportTypes=function(c,d,e){var f=[];for(var g=0;g<a.length;++g){var h=a[g];b[h].accept(c,d,e)===!0&&f.push(h)}return f},this.negotiateTransport=function(c,d,e,f){for(var g=0;g<a.length;++g){var h=a[g];for(var i=0;i<c.length;++i)if(h==c[i]){var j=b[h];if(j.accept(d,e,f)===!0)return j}}return null},this.add=function(c,d,e){var f=!1;for(var g=0;g<a.length;++g)if(a[g]==c){f=!0;break}f||(typeof e!=="number"?a.push(c):a.splice(e,0,c),b[c]=d);return!f},this.find=function(c){for(var d=0;d<a.length;++d)if(a[d]==type)return b[type];return null},this.remove=function(c){for(var d=0;d<a.length;++d)if(a[d]==c){a.splice(d,1);var e=b[c];delete b[c];return e}return null},this.reset=function(){for(var c=0;c<a.length;++c)b[a[c]].reset()}},org.cometd.Transport=function(){var a,b;this.registered=function(c,d){a=c,b=d},this.unregistered=function(){a=null,b=null},this._debug=function(){b._debug.apply(b,arguments)},this.getConfiguration=function(){return b.getConfiguration()},this.getAdvice=function(){return b.getAdvice()},this.setTimeout=function(a,c){return org.cometd.Utils.setTimeout(b,a,c)},this.convertToMessages=function(a){if(org.cometd.Utils.isString(a))try{return org.cometd.JSON.fromJSON(a)}catch(b){this._debug("Could not convert to JSON the following string",'"'+a+'"');throw b}if(org.cometd.Utils.isArray(a))return a;if(a===undefined||a===null)return[];if(a instanceof Object)return[a];throw"Conversion Error "+a+", typeof "+typeof a},this.accept=function(a,b,c){throw"Abstract"},this.getType=function(){return a},this.send=function(a,b){throw"Abstract"},this.reset=function(){this._debug("Transport",a,"reset")},this.abort=function(){this._debug("Transport",a,"aborted")},this.toString=function(){return this.getType()}},org.cometd.Transport.derive=function(a){function b(){}b.prototype=a;return new b},org.cometd.RequestTransport=function(){function l(a){if(d!==null)throw"Concurrent metaConnect requests not allowed, request id="+d.id+" not yet completed";var b=++c;this._debug("Transport",this,"metaConnect send",b,a);var e={id:b,metaConnect:!0};h.call(this,a,e),d=e}function k(a,b){var c=org.cometd.Utils.inArray(a,e);c>=0&&e.splice(c,1);if(f.length>0){var d=f.shift(),h=d[0],j=d[1];this._debug("Transport dequeued request",j.id);if(b)this.getConfiguration().autoBatch&&g.call(this,h),i.call(this,h),this._debug("Transport completed request",a.id,h);else{var k=this;this.setTimeout(function(){k.complete(j,!1,j.metaConnect),h.onFailure(j.xhr,"error","Previous request failed")},0)}}}function j(a){var b=a.id;this._debug("Transport",this,"metaConnect complete",b);if(d!==null&&d.id!==b)throw"Longpoll request mismatch, completing request "+b;d=null}function i(a){var b=++c,d={id:b,metaConnect:!1};e.length<this.getConfiguration().maxConnections-1?(this._debug("Transport",this,"sending request",b,a),h.call(this,a,d),e.push(d)):(this._debug("Transport queueing request",b,a),f.push([a,d]))}function h(a,b){this.transportSend(a,b),b.expired=!1;if(!a.sync){var c=this.getConfiguration().maxNetworkDelay,d=c;b.metaConnect===!0&&(d+=this.getAdvice().timeout),this._debug("Transport",this,"waiting at most",d,"ms for the response, maxNetworkDelay =",c);var e=this;b.timeout=this.setTimeout(function(){b.expired=!0,b.xhr&&b.xhr.abort();var c="Request "+b.id+" of transport "+e.getType()+" exceeded "+d+" ms max network delay";e._debug(c),e.complete(b,!1,b.metaConnect),a.onFailure(b.xhr,"timeout",c)},d)}}function g(a){while(f.length>0){var b=f[0],c=b[0],d=b[1];if(c.url===a.url&&c.sync===a.sync){f.shift(),a.messages=a.messages.concat(c.messages),this._debug("Coalesced",c.messages.length,"messages from request",d.id);continue}break}}var a=new org.cometd.Transport,b=org.cometd.Transport.derive(a),c=0,d=null,e=[],f=[];b.complete=function(a,b,c){c?j.call(this,a):k.call(this,a,b)},b.transportSend=function(a,b){throw"Abstract"},b.transportSuccess=function(a,b,c){b.expired||(clearTimeout(b.timeout),this.complete(b,!0,b.metaConnect),c&&c.length>0?a.onSuccess(c):a.onFailure(b,"Empty HTTP response"))},b.transportFailure=function(a,b,c,d){b.expired||(clearTimeout(b.timeout),this.complete(b,!1,b.metaConnect),a.onFailure(b.xhr,c,d))},b.send=function(a,b){b?l.call(this,a):i.call(this,a)},b.abort=function(){a.abort();for(var b=0;b<e.length;++b){var c=e[b];this._debug("Aborting request",c),c.xhr&&c.xhr.abort()}d&&(this._debug("Aborting metaConnect request",d),d.xhr&&d.xhr.abort()),this.reset()},b.reset=function(){a.reset(),d=null,e=[],f=[]};return b},org.cometd.LongPollingTransport=function(){var a=new org.cometd.RequestTransport,b=org.cometd.Transport.derive(a),c=!0;b.accept=function(a,b,d){return c||!b},b.xhrSend=function(a){throw"Abstract"},b.transportSend=function(a,b){var d=this;try{var e=!0;b.xhr=this.xhrSend({transport:this,url:a.url,sync:a.sync,headers:this.getConfiguration().requestHeaders,body:org.cometd.JSON.toJSON(a.messages),onSuccess:function(e){d._debug("Transport",d,"received response",e);var f=!1;try{var g=d.convertToMessages(e);g.length===0?(c=!1,d.transportFailure(a,b,"no response",null)):(f=!0,d.transportSuccess(a,b,g))}catch(h){d._debug(h),f||(c=!1,d.transportFailure(a,b,"bad response",h))}},onError:function(f,g){c=!1,e?d.setTimeout(function(){d.transportFailure(a,b,f,g)},0):d.transportFailure(a,b,f,g)}}),e=!1}catch(f){c=!1,this.setTimeout(function(){d.transportFailure(a,b,"error",f)},0)}},b.reset=function(){a.reset(),c=!0};return b},org.cometd.CallbackPollingTransport=function(){var a=new org.cometd.RequestTransport,b=org.cometd.Transport.derive(a),c=2e3;b.accept=function(a,b,c){return!0},b.jsonpSend=function(a){throw"Abstract"},b.transportSend=function(a,b){var d=org.cometd.JSON.toJSON(a.messages),e=a.url.length+encodeURI(d).length,f=this;if(e>c){var g=a.messages.length>1?"Too many bayeux messages in the same batch resulting in message too big ("+e+" bytes, max is "+c+") for transport "+this.getType():"Bayeux message too big ("+e+" bytes, max is "+c+") for transport "+this.getType();this.setTimeout(function(){f.transportFailure(a,b,"error",g)},0)}else try{var h=!0;this.jsonpSend({transport:this,url:a.url,sync:a.sync,headers:this.getConfiguration().requestHeaders,body:d,onSuccess:function(c){var d=!1;try{var e=f.convertToMessages(c);e.length===0?f.transportFailure(a,b,"no response",null):(d=!0,f.transportSuccess(a,b,e))}catch(g){f._debug(g),d||f.transportFailure(a,b,"bad response",g)}},onError:function(c,d){h?f.setTimeout(function(){f.transportFailure(a,b,c,d)},0):f.transportFailure(a,b,c,d)}}),h=!1}catch(i){this.setTimeout(function(){f.transportFailure(a,b,"error",i)},0)}};return b},org.cometd.WebSocketTransport=function(){function m(a,b){try{var c=org.cometd.JSON.toJSON(a.messages);k.send(c),this._debug("Transport",this,"sent",a,"metaConnect =",b);var d=this.getConfiguration().maxNetworkDelay,e=d;b&&(e+=this.getAdvice().timeout);var f=[];for(var g=0;g<a.messages.length;++g){var h=a.messages[g];if(h.id){f.push(h.id);var l=this;i[h.id]=this.setTimeout(function(){var b="Message "+h.id+" of transport "+l.getType()+" exceeded "+e+" ms max network delay";l._debug(b),delete i[h.id];for(var c in j)if(j[c]===a){delete j[c];break}a.onFailure(k,"timeout",b)},e)}}this._debug("Transport",this,"waiting at most",e," ms for messages",f,"maxNetworkDelay =",d,", timeouts:",org.cometd.JSON.toJSON(i))}catch(m){this.setTimeout(function(){a.onFailure(k,"error",m)},0)}}var a=1,b=2,c=new org.cometd.Transport,d=org.cometd.Transport.derive(c),e,f=!0,g=!1,h=b,i={},j={},k,l;d.registered=function(a,b){c.registered(a,b),e=b},d.accept=function(a,b,c){return f&&!!window.WebSocket&&e.websocketEnabled===!0},d.onMessage=function(b){this._debug("Transport",this,"received websocket message",b);if(h===a){var c=this.convertToMessages(b.data),d=[];for(var e=0;e<c.length;++e){var f=c[e];if(/^\/meta\//.test(f.channel)||f.data===undefined)if(f.id){d.push(f.id);var g=i[f.id];g&&(clearTimeout(g),delete i[f.id],this._debug("Transport",this,"removed timeout for message",f.id,", timeouts:",org.cometd.JSON.toJSON(i)))}"/meta/disconnect"===f.channel&&f.successful&&k.close()}var m=!1;for(var n=0;n<d.length;++n){var o=d[n];for(var p in j){var q=p.split(","),r=org.cometd.Utils.inArray(o,q);if(r>=0){m=!0,q.splice(r,1);var s=j[p];delete j[p],q.length>0&&(j[q.join(",")]=s);break}}}m&&this._debug("Transport",this,"removed envelope, envelopes:",org.cometd.JSON.toJSON(j)),l.call(this,c)}},d.onClose=function(){this._debug("Transport",this,"closed",k),f=g;for(var a in i)clearTimeout(i[a]),delete i[a];for(var c in j)j[c].onFailure(k,"closed"),delete j[c];h=b},d.send=function(b,c){this._debug("Transport",this,"sending",b,"metaConnect =",c);var d=[];for(var e=0;e<b.messages.length;++e){var f=b.messages[e];f.id&&d.push(f.id)}j[d.join(",")]=b,this._debug("Transport",this,"stored envelope, envelopes:",org.cometd.JSON.toJSON(j));if(h===a)m.call(this,b,c);else{var i=b.url.replace(/^http/,"ws");this._debug("Transport",this,"connecting to URL",i),k=new window.WebSocket(i);var n=this;k.onopen=function(){n._debug("WebSocket opened",k),g=!0,h=a,l=b.onSuccess,m.call(n,b,c)},k.onclose=function(){n.onClose()},k.onmessage=function(a){n.onMessage(a)}}},d.reset=function(){c.reset(),k&&k.close(),f=!0,g=!1,h=b,i={},j={},k=null,l=null};return d},org.cometd.Cometd=function(a){function bx(a){var b=m[a[0]];b&&(delete b[a[1]],B("Removed listener",a))}function bw(a,b,c,d){var e=bv(b,c);B("Adding listener on",a,"with scope",e.scope,"and callback",e.method);var f={channel:a,scope:e.scope,callback:e.method,listener:d},g=m[a];g||(g=[],m[a]=g);var h=g.push(f)-1;f.id=h,f.handle=[a,h],B("Added listener",f,"for channel",a,"having id =",h);return f.handle}function bv(a,b){var c={scope:a,method:b};if(x(a))c.scope=undefined,c.method=a;else if(w(b)){if(!a)throw"Invalid scope "+a;c.method=a[b];if(!x(c.method))throw"Invalid callback "+b+" for scope "+a}else if(!x(b))throw"Invalid callback "+b;return c}function bu(a){var b=m[a];if(b)for(var c=0;c<b.length;++c)if(b[c])return!0;return!1}function bt(a){a=I(a);if(a!==undefined&&a!==null){Z(a.advice);var b=a.channel;switch(b){case"/meta/handshake":bb(a);break;case"/meta/connect":be(a);break;case"/meta/disconnect":bi(a);break;case"/meta/subscribe":bl(a);break;case"/meta/unsubscribe":bo(a);break;default:br(a)}}}function bs(a,b){bq({successful:!1,failure:!0,channel:b.channel,request:b,xhr:a,advice:{reconnect:"none",interval:0}})}function br(a){a.successful===undefined?a.data?L(a.channel,a):B("Unknown message",a):a.successful?L("/meta/publish",a):bq(a)}function bq(a){L("/meta/publish",a),L("/meta/unsuccessful",a)}function bp(a,b){bn({successful:!1,failure:!0,channel:"/meta/unsubscribe",request:b,xhr:a,advice:{reconnect:"none",interval:0}})}function bo(a){a.successful?L("/meta/unsubscribe",a):bn(a)}function bn(a){L("/meta/unsubscribe",a),L("/meta/unsuccessful",a)}function bm(a,b){bk({successful:!1,failure:!0,channel:"/meta/subscribe",request:b,xhr:a,advice:{reconnect:"none",interval:0}})}function bl(a){a.successful?L("/meta/subscribe",a):bk(a)}function bk(a){L("/meta/subscribe",a),L("/meta/unsuccessful",a)}function bj(a,b){bh({successful:!1,failure:!0,channel:"/meta/disconnect",request:b,xhr:a,advice:{reconnect:"none",interval:0}})}function bi(a){a.successful?(bg(!1),L("/meta/disconnect",a)):bh(a)}function bh(a){bg(!0),L("/meta/disconnect",a),L("/meta/unsuccessful",a)}function bg(a){M(),a&&f.abort(),i=null,E("disconnected"),j=0,k=[],S()}function bf(a,b){t=!1,bd({successful:!1,failure:!0,channel:"/meta/connect",request:b,xhr:a,advice:{reconnect:"retry",interval:n}})}function be(a){t=a.successful;if(t){L("/meta/connect",a);var b=F()?"none":q.reconnect;switch(b){case"retry":S(),Y();break;case"none":S(),E("disconnected");break;default:throw"Unrecognized advice action "+b}}else bd(a)}function bd(a){L("/meta/connect",a),L("/meta/unsuccessful",a);var b=F()?"none":q.reconnect;switch(b){case"retry":T(),Y();break;case"handshake":S(),_();break;case"none":S(),E("disconnected");break;default:throw"Unrecognized advice action"+b}}function bc(a,b){ba({successful:!1,failure:!0,channel:"/meta/handshake",request:b,xhr:a,advice:{reconnect:"retry",interval:n}})}function bb(a){if(a.successful){i=a.clientId;var b=e.negotiateTransport(a.supportedConnectionTypes,a.version,d,u.url);if(b===null)throw"Could not negotiate transport with server; client "+e.findTransportTypes(a.version,d,u.url)+", server "+a.supportedConnectionTypes;f!=b&&(B("Transport",f,"->",b),f=b),l=!1,V(),a.reestablish=s,s=!0,L("/meta/handshake",a);var c=F()?"none":q.reconnect;switch(c){case"retry":S(),Y();break;case"none":S(),E("disconnected");break;default:throw"Unrecognized advice action "+c}}else ba(a)}function ba(a){L("/meta/handshake",a),L("/meta/unsuccessful",a);var b=!F()&&q.reconnect!="none";b?(T(),_()):(S(),E("disconnected"))}function _(){E("handshaking"),l=!0,N(function(){$(r)})}function $(a){i=null,D(),F()&&e.reset(),F()?Z(u.advice):Z(v(!1,q,{reconnect:"retry"})),j=0,l=!0,r=a;var b="1.0",c=e.findTransportTypes(b,d,u.url),g={version:b,minimumVersion:"0.9",channel:"/meta/handshake",supportedConnectionTypes:c,advice:{timeout:q.timeout,interval:q.interval}},h=v(!1,{},r,g);f=e.negotiateTransport(c,b,d,u.url),B("Initial transport is",f.getType(),f),E("handshaking"),B("Handshake sent",h),Q(!1,[h],!1,"handshake")}function Z(a){a&&(q=v(!1,{},u.advice,a),B("New advice",q,org.cometd.JSON.toJSON(q)))}function Y(){E("connecting"),N(function(){X()})}function X(){if(!F()){var a={channel:"/meta/connect",connectionType:f.getType()};t||(a.advice={timeout:0}),E("connecting"),B("Connect sent",a,org.cometd.JSON.toJSON(a)),Q(!1,[a],!0,"connect"),E("connected")}}function W(){--j;if(j<0)throw"Calls to startBatch() and endBatch() are not paired";j===0&&!F()&&!l&&V()}function V(){var a=k;k=[],a.length>0&&Q(!1,a,!1)}function U(){++j}function T(){n<u.maxBackoff&&(n+=u.backoffIncrement)}function S(){n=0}function R(a){j>0||l===!0?k.push(a):Q(!1,[a],!1)}function Q(a,c,d,e){for(var g=0;g<c.length;++g){var h=c[g];h.id=""+G(),i&&(h.clientId=i),h=J(h),h!==undefined&&h!==null?c[g]=h:c.splice(g--,1)}if(c.length!==0){var j=u.url;u.appendMessageTypeToURL&&(j.match(/\/$/)||(j=j+"/"),e&&(j=j+e));var k={url:j,sync:a,messages:c,onSuccess:function(a){try{O.call(b,a)}catch(c){B("Exception during handling of messages",c)}},onFailure:function(a,d,e){try{P.call(b,a,c,d,e)}catch(f){B("Exception during handling of failure",f)}}};B("Send, sync =",a,k),f.send(k,d)}}function N(a){M();var c=q.interval+n;B("Function scheduled in",c,"ms, interval =",q.interval,"backoff =",n,a),o=org.cometd.Utils.setTimeout(b,a,c)}function M(){o!==null&&clearTimeout(o),o=null}function L(a,b){K(a,b);var c=a.split("/"),d=c.length-1;for(var e=d;e>0;--e){var f=c.slice(0,e).join("/")+"/*";e==d&&K(f,b),f+="*",K(f,b)}}function K(a,c){var d=m[a];if(d&&d.length>0)for(var e=0;e<d.length;++e){var f=d[e];if(f)try{f.callback.call(f.scope,c)}catch(g){B("Exception during notification",f,c,g);var h=b.onListenerException;if(x(h)){B("Invoking listener exception callback",f,g);try{h.call(b,g,f.handle,f.listener,c)}catch(i){A("Exception during execution of listener callback",f,i)}}}}}function J(a){for(var b=0;b<p.length;++b){if(a===undefined||a===null)break;var c=p[b],d=c.extension.outgoing;if(x(d)){var e=H(c.extension,d,c.name,a,!0);a=e===undefined?a:e}}return a}function I(a){for(var b=0;b<p.length;++b){if(a===undefined||a===null)break;var c=u.reverseIncomingExtensions?p.length-1-b:b,d=p[c],e=d.extension.incoming;if(x(e)){var f=H(d.extension,e,d.name,a,!1);a=f===undefined?a:f}}return a}function H(a,c,d,e,f){try{return c.call(a,e)}catch(g){B("Exception during execution of extension",d,g);var h=b.onExtensionException;if(x(h)){B("Invoking extension exception callback",d,g);try{h.call(b,g,d,f,e)}catch(i){A("Exception during execution of exception callback in extension",d,i)}}return e}}function G(){return++h}function F(){return g=="disconnecting"||g=="disconnected"}function E(a){g!=a&&(B("Status",g,"->",a),g=a)}function D(){for(var a in m){var b=m[a];for(var c=0;c<b.length;++c){var d=b[c];d&&!d.listener&&(delete b[c],B("Removed subscription",d,"for channel",a))}}}function C(a){B("Configuring cometd object with",a),w(a)&&(a={url:a}),a||(a={}),u=v(!1,u,a);if(!u.url)throw"Missing required configuration parameter 'url' specifying the Bayeux server URL";var b=/(^https?:)?(\/\/(([^:\/\?#]+)(:(\d+))?))?([^\?#]*)(.*)?/.exec(u.url);d=b[3]&&b[3]!=window.location.host;if(u.appendMessageTypeToURL)if(b[8]!==undefined&&b[8].length>0)A("Appending message type to URI "+b[7]+b[8]+" is not supported, disabling 'appendMessageTypeToURL' configuration"),u.appendMessageTypeToURL=!1;else{var c=b[7].split("/"),e=c.length-1;b[7].match(/\/$/)&&(e-=1),c[e].indexOf(".")>=0&&(A("Appending message type to URI "+b[7]+" is not supported, disabling 'appendMessageTypeToURL' configuration"),u.appendMessageTypeToURL=!1)}}function B(){u.logLevel=="debug"&&y("debug",arguments)}function A(){u.logLevel!="warn"&&y("info",arguments)}function z(){y("warn",arguments)}function y(a,b){if(window.console){var c=window.console[a];x(c)&&c.apply(window.console,b)}}function x(a){if(a===undefined||a===null)return!1;return typeof a==="function"}function w(a){return org.cometd.Utils.isString(a)}function v(a,b,c){var d=b||{};for(var e=2;e<arguments.length;++e){var f=arguments[e];if(f===undefined||f===null)continue;for(var g in f){var h=f[g];if(h===b)continue;if(h===undefined)continue;a&&typeof h==="object"&&h!==null?h instanceof Array?d[g]=v(a,[],h):d[g]=v(a,{},h):d[g]=h}}return d}var b=this,c=a||"default",d=!1,e=new org.cometd.TransportRegistry,f,g="disconnected",h=0,i=null,j=0,k=[],l=!1,m={},n=0,o=null,p=[],q={},r,s=!1,t=!1,u={maxConnections:2,backoffIncrement:1e3,maxBackoff:6e4,logLevel:"info",reverseIncomingExtensions:!0,maxNetworkDelay:1e4,requestHeaders:{},appendMessageTypeToURL:!0,autoBatch:!1,advice:{timeout:6e4,interval:0,reconnect:"retry"}};this._mixin=v,this._warn=z,this._info=A,this._debug=B;var O,P;this.send=R,this.receive=bt,O=function O(a){B("Received",a,org.cometd.JSON.toJSON(a));for(var b=0;b<a.length;++b){var c=a[b];bt(c)}},P=function P(a,b,c,d){B("handleFailure",a,b,c,d);for(var e=0;e<b.length;++e){var f=b[e],g=f.channel;switch(g){case"/meta/handshake":bc(a,f);break;case"/meta/connect":bf(a,f);break;case"/meta/disconnect":bj(a,f);break;case"/meta/subscribe":bm(a,f);break;case"/meta/unsubscribe":bp(a,f);break;default:bs(a,f)}}},this.registerTransport=function(a,b,c){var d=e.add(a,b,c);d&&(B("Registered transport",a),x(b.registered)&&b.registered(a,this));return d},this.getTransportTypes=function(){return e.getTransportTypes()},this.unregisterTransport=function(a){var b=e.remove(a);b!==null&&(B("Unregistered transport",a),x(b.unregistered)&&b.unregistered());return b},this.findTransport=function(a){return e.find(a)},this.configure=function(a){C.call(this,a)},this.init=function(a,b){this.configure(a),this.handshake(b)},this.handshake=function(a){E("disconnected"),s=!1,$(a)},this.disconnect=function(a,b){if(!F()){b===undefined&&(typeof a!=="boolean"&&(b=a,a=!1));var c={channel:"/meta/disconnect"},d=v(!1,{},b,c);E("disconnecting"),Q(a===!0,[d],!1,"disconnect")}},this.startBatch=function(){U()},this.endBatch=function(){W()},this.batch=function(a,b){var c=bv(a,b);this.startBatch();try{c.method.call(c.scope),this.endBatch()}catch(d){B("Exception during execution of batch",d),this.endBatch();throw d}},this.addListener=function(a,b,c){if(arguments.length<2)throw"Illegal arguments number: required 2, got "+arguments.length;if(!w(a))throw"Illegal argument type: channel must be a string";return bw(a,b,c,!0)},this.removeListener=function(a){if(!org.cometd.Utils.isArray(a))throw"Invalid argument: expected subscription, not "+a;bx(a)},this.clearListeners=function(){m={}},this.subscribe=function(a,b,c,d){if(arguments.length<2)throw"Illegal arguments number: required 2, got "+arguments.length;if(!w(a))throw"Illegal argument type: channel must be a string";if(F())throw"Illegal state: already disconnected";x(b)&&(d=c,c=b,b=undefined);var e=!bu(a),f=bw(a,b,c,!1);if(e){var g={channel:"/meta/subscribe",subscription:a},h=v(!1,{},d,g);R(h)}return f},this.unsubscribe=function(a,b){if(arguments.length<1)throw"Illegal arguments number: required 1, got "+arguments.length;if(F())throw"Illegal state: already disconnected";this.removeListener(a);var c=a[0];if(!bu(c)){var d={channel:"/meta/unsubscribe",subscription:c},e=v(!1,{},b,d);R(e)}},this.clearSubscriptions=function(){D()},this.publish=function(a,b,c){if(arguments.length<1)throw"Illegal arguments number: required 1, got "+arguments.length;if(!w(a))throw"Illegal argument type: channel must be a string";if(F())throw"Illegal state: already disconnected";var d={channel:a,data:b},e=v(!1,{},c,d);R(e)},this.getStatus=function(){return g},this.isDisconnected=F,this.setBackoffIncrement=function(a){u.backoffIncrement=a},this.getBackoffIncrement=function(){return u.backoffIncrement},this.getBackoffPeriod=function(){return n},this.setLogLevel=function(a){u.logLevel=a},this.registerExtension=function(a,b){if(arguments.length<2)throw"Illegal arguments number: required 2, got "+arguments.length;if(!w(a))throw"Illegal argument type: extension name must be a string";var c=!1;for(var d=0;d<p.length;++d){var e=p[d];if(e.name==a){c=!0;break}}if(c){A("Could not register extension with name",a,"since another extension with the same name already exists");return!1}p.push({name:a,extension:b}),B("Registered extension",a),x(b.registered)&&b.registered(a,this);return!0},this.unregisterExtension=function(a){if(!w(a))throw"Illegal argument type: extension name must be a string";var b=!1;for(var c=0;c<p.length;++c){var d=p[c];if(d.name==a){p.splice(c,1),b=!0,B("Unregistered extension",a);var e=d.extension;x(e.unregistered)&&e.unregistered();break}}return b},this.getExtension=function(a){for(var b=0;b<p.length;++b){var c=p[b];if(c.name==a)return c.extension}return null},this.getName=function(){return c},this.getClientId=function(){return i},this.getURL=function(){return u.url},this.getTransport=function(){return f},this.getConfiguration=function(){return v(!0,{},u)},this.getAdvice=function(){return v(!0,{},q)}},typeof dojo!="undefined"&&dojo.provide("org.cometd.AckExtension"),org.cometd.AckExtension=function(){function d(b,c){a._debug(b,c)}var a,b=!1,c=-1;this.registered=function(b,c){a=c,d("AckExtension: executing registration callback")},this.unregistered=function(){d("AckExtension: executing unregistration callback"),a=null},this.incoming=function(a){var e=a.channel;if(e=="/meta/handshake")b=a.ext&&a.ext.ack,d("AckExtension: server supports acks",b);else if(b&&e=="/meta/connect"&&a.successful){var f=a.ext;f&&typeof f.ack==="number"&&(c=f.ack,d("AckExtension: server sent ack id",c))}return a},this.outgoing=function(e){var f=e.channel;f=="/meta/handshake"?(e.ext||(e.ext={}),e.ext.ack=a&&a.ackEnabled!==!1,c=-1):b&&f=="/meta/connect"&&(e.ext||(e.ext={}),e.ext.ack=c,d("AckExtension: client sending ack id",c));return e}};return org.cometd}),define("coweb/session/bayeux/cometd",["coweb/util/xhr","org/cometd"],function(a,b){b.JSON.toJSON=JSON.stringify,b.JSON.fromJSON=JSON.parse;var c=new b.Cometd,d=function(){var c=new b.LongPollingTransport,d=b.Transport.derive(c);d.xhrSend=function(b){b.method="POST",b.headers=b.headers||{},b.headers["Content-Type"]="application/json;charset=UTF-8";var c=a.send(b);c.then(function(a){b.onSuccess(a.xhr.responseText)},function(a){var c=new Error("failed loading "+a.url+" status: "+a.xhr.status);b.onError(a.xhr.statusText,c)});return c.xhr};return d};c.registerTransport("long-polling",new d),c.registerExtension("ack",new b.AckExtension);return c}),define("coweb/session/bayeux/CowebExtension",["require","exports","module"],function(){var a=function(a){this._cometd=null,this._sessionid=a.sessionid};a.prototype.registered=function(a,b){this._cometd=b},a.prototype.unregistered=function(a,b){this._cometd=null},a.prototype.outgoing=function(a){var b=a.ext=a.ext||{},c=a.ext.coweb=a.ext.coweb||{};c.sessionid=this._sessionid;return a};return a}),define("coweb/util/lang",["require","exports","module"],function(){return{clone:function(a){return JSON.parse(JSON.stringify(a))}}}),define("coweb/session/bayeux/ListenerBridge",["coweb/session/bayeux/cometd","coweb/util/Promise","coweb/util/lang"],function(a,b,c){var d=function(a){this.IDLE=0,this.UPDATING=1,this.UPDATED=2,this._listener=a.listener,this._bridge=a.bridge,this._joinToken=null,this._rosterToken=null,this._updaterToken=null,this._syncToken=null,this._stateReqs={},this._state=this.IDLE,this._serviceSubs={},this._serviceReqs={},this._publicRegex=/^\/bot\/(.*)/,this._privateRegex=/^\/service\/bot\/([^\/]*)\/response/,this._requestRegex=/^\/service\/bot\/([^\/]*)\/request/,this._updatePromise=null,this._updateQueue=[],this._roster=null},e=d.prototype;e.postSync=function(b,c,d,e,f){if(this._state===this.UPDATED){a.publish("/session/sync/app",{topic:b,value:c,type:d,position:e,context:f});return!0}},e.postEngineSync=function(b){if(this._state===this.UPDATED){a.publish("/session/sync/engine",{context:b});return!0}},e.postStateResponse=function(b,d,e){var f=this._stateReqs[e];f!==undefined&&(b?(d=c.clone(d),f.push({topic:b,value:d})):(f={token:e,state:f},a.publish("/service/session/updater",f),delete this._stateReqs[e]))},e.postServiceSubscribe=function(b){var c=this._serviceSubs[b];if(!c){var d=a.subscribe("/bot/"+b,this,"_onServiceBotPublish");c={count:0,token:d},this._serviceSubs[b]=c}c.count+=1},e.postServiceRequest=function(b,c,d){var e=this._serviceReqs[b];e||(this._serviceReqs[b]=e={token:null,pending:{}});if(!e.token){var f="/service/bot/"+b+"/response",g=a.subscribe(f,this,"_onServiceBotResponse");e.token=g}e.pending[d]?console.warn("bayeux.ListenerBridge: conflict in bot request topics "+d):(a.publish("/service/bot/"+b+"/request",{value:c,topic:d}),e.pending[d]=!0)},e.postServiceUnsubscribe=function(b){var c=this._serviceSubs[b];c?(c.count-=1,c.count<=0&&(c.token&&a.unsubscribe(c.token),delete this._serviceSubs[b])):delete this._serviceSubs[b]},e.initiateUpdate=function(){this._updatePromise=new b,a.addListener("/meta/subscribe",this,"_onSubscribe"),a.addListener("/meta/publish",this,"_onPublish"),this._state=this.UPDATING,this._updateQueue=[],a.batch(this,function(){this._rosterToken=a.subscribe("/session/roster/*",this,"_onSessionRoster"),this._syncToken=a.subscribe("/session/sync/*",this,"_onSessionSync"),this._joinToken=a.subscribe("/service/session/join/*",this,"_onServiceSessionJoin")});return this._updatePromise},e.getInitialRoster=function(){var a=this._roster;this._roster=null;return a},e._onSubscribe=function(b){var c,d,e;if(!b.successful){var f=b.subscription,g=this._privateRegex.exec(f);if(g){d=this._serviceReqs[g[1]],a.removeListener(d.token),d.token=null,e=b.error.split(":");for(c in d.pending)d.pending.hasOwnProperty(c)&&this._listener.serviceResponseInbound(c,e[2],!0);d.pending={}}g=this._publicRegex.exec(f),g&&(d=this._serviceSubs[g[1]],a.removeListener(d.token),d.token=null,e=b.error.split(":"),this._listener.servicePublishInbound(g[1],e[2],!0))}},e._onPublish=function(b){if(!b.successful){var c=b.channel,d=this._requestRegex.exec(c);if(d){var e=this._serviceReqs[d[1]];a.removeListener(e.token),e.token=null;var f=b.error.split(":");for(var g in e.pending)e.pending.hasOwnProperty(g)&&this._listener.serviceResponseInbound(g,f[2],!0);e.pending={};return}}},e._onServiceSessionJoin=function(a){var b=a.channel.split("/");b=b[b.length-1];if(b==="siteid")this._listener.setSiteID(a.data);else if(b==="roster")this._roster=a.data;else if(b==="state"){var c=this._updatePromise;this._updatePromise=null;try{this._onServiceSessionJoinState(a)}catch(d){c.fail(new Error("bad-application-state"))}this._listener.start(this,this._bridge.prepResponse),c.resolve()}else console.warn("bayeux.ListenerBridge: unknown message "+a.channel)},e._onServiceSessionJoinState=function(b){var c,d,e;for(c=0,d=b.data.length;c<d;c++){e=b.data[c];try{this._listener.stateInbound(e.topic,e.value)}catch(f){console.warn("bayeux.ListenerBridge: application errored on received state "+f.message);throw f}}for(c=0,d=this._updateQueue.length;c<d;c++){e=this._updateQueue[c];try{this[e.mtd](e.args)}catch(g){console.warn("bayeux.ListenerBridge: application errored on queued event "+g.message);throw g}}a.batch(this,function(){a.unsubscribe(this._joinToken),this._joinToken=null,this._updaterToken=a.subscribe("/service/session/updater",this,"_onServiceSessionUpdater")}),this._state=this.UPDATED,this._updateQueue=[]},e._onSessionSync=function(a){var b=a.data;if(this._state===this.UPDATING)this._updateQueue.push({mtd:"_onSessionSync",args:a});else{var c=a.channel.split("/"),d=c[c.length-1];d==="engine"?this._listener.engineSyncInbound(b.siteId,b.context):d==="app"?this._listener.syncInbound(b.topic,b.value,b.type,b.position,b.siteId,b.context,b.order):console.warn("bayeux.ListenerBridge: received unknown sync "+c)}},e._onSessionRoster=function(a){if(this._state===this.UPDATING)this._updateQueue.push({mtd:"_onSessionRoster",args:a});else{var b=a.channel.split("/");b=b[b.length-1],b==="available"||b==="unavailable"?this._listener.noticeInbound(b,a.data):console.warn("bayeux.ListenerBridge: unknown message "+a.channel)}},e._onServiceSessionUpdater=function(a){var b=a.data;this._stateReqs[b]=[];try{this._listener.requestStateInbound(b)}catch(c){this._bridge.onDisconnected(this._bridge.id,"bad-application-state")}},e._onServiceBotPublish=function(a){var b=a.channel,c=this._publicRegex.exec(b);if(c){var d=c[1];this._listener.servicePublishInbound(d,a.data.value,!1)}else console.warn("bayeux.ListenerBridge: unknown bot publish "+b)},e._onServiceBotResponse=function(a){var b=a.channel,c=a.data.topic,d=this._privateRegex.exec(b);if(d){var e=this._serviceReqs[d[1]];if(!e.pending[c]){console.warn("bayeux.ListenerBridge: unknown bot response "+b);return}delete e.pending[c],this._listener.serviceResponseInbound(c,a.data.value,!1)}else console.warn("bayeux.ListenerBridge: unknown bot response "+b)};return d}),define("coweb/session/bayeux/SessionBridge",["coweb/session/bayeux/cometd","coweb/session/bayeux/CowebExtension","coweb/session/bayeux/ListenerBridge","coweb/util/Promise","coweb/util/xhr"],function(a,b,c,d,e){var f=function(a){this.DISCONNECTING=0,this.IDLE=1,this.PREPARING=2,this.PREPARED=3,this.JOINING=4,this.JOINED=5,this.UPDATING=6,this.UPDATED=7,this._debug=a.debug,this._adminUrl=a.adminUrl,this._state=this.IDLE,this._connectToken=null,this._prepPromise=null,this._joinPromise=null,this._updatePromise=null,this.disconnectPromise=null,this.prepResponse=null,this._bridge=new c({debug:this._debug,listener:a.listener,bridge:this})},g=f.prototype;g.destroy=function(){this._prepPromise=null,this._joinPromise=null,this._updatePromise=null,this._state!==this.IDLE&&this.disconnect(!0)},g.getState=function(){return this._state},g.prepare=function(a,b){if(this._state!==this.IDLE)throw new Error(this.id+": cannot prepare in non-idle state");this.disconnectPromise=new d,this._prepPromise=new d;var c={key:a,collab:b},f={method:"POST",url:this._adminUrl,headers:{"Content-Type":"application/json;charset=UTF-8"},body:JSON.stringify(c)},g=e.send(f);g.then("_onPrepareResponse","_onPrepareError",this),this._state=this.PREPARING;return this._prepPromise},g._onPrepareResponse=function(a){var b=JSON.parse(a.xhr.responseText);if(this._state===this.PREPARING){this._state=this.PREPARED;var c=this._prepPromise;this._prepPromise=null,this.prepResponse=b,c.resolve(b)}},g._onPrepareError=function(a){this._state=this.IDLE;var b=this._prepPromise;this._prepPromise=null;var c=a.xhr.status;c===403||c===401?b.fail(new Error("not-allowed")):b.fail(new Error("server-unavailable"))},g.join=function(){if(this._state!==this.PREPARED)throw new Error(this.id+": cannot join in unprepared state");this._joinPromise=new d,a.unregisterExtension("coweb");var c={sessionid:this.prepResponse.sessionid};a.registerExtension("coweb",new b(c)),a.configure({url:this.prepResponse.sessionurl,logLevel:this._debug?"debug":"info",autoBatch:!0,appendMessageTypeToURL:!1}),a.addListener("/meta/unsuccessful",this,"_onSessionUnsuccessful"),this._connectToken=a.addListener("/meta/connect",this,"_onSessionConnect"),a.addListener("/meta/disconnect",this,"_onSessionDisconnect"),this._state=this.JOINING,a.handshake();return this._joinPromise},g._onSessionUnsuccessful=function(a){var b="";a&&a.error&&(b=a.error.slice(0,3));var c;if(b==="500")this.onDisconnected(this._state,"stream-error"),this.disconnect();else if(a.xhr&&this._state>this.IDLE){var d=a.xhr.status;d===403||d===401?c="not-allowed":d===0?c="server-unavailable":d<500?this._state>this.PREPARING&&(c="session-unavailable"):c="server-unavailable",this._onDisconnected(this._state,c),this.disconnect();var e=this._joinPromise||this._updatePromise;e&&(this._updatePromise=null,this._joinPromise=null,e.fail(new Error(c)))}},g._onSessionConnect=function(b){if(this._state===this.JOINING){this._state=this.JOINED;var c=this._joinPromise;this._joinPromise=null,c.resolve(),a.removeListener(this._connectToken),this._connectToken=null}},g._onSessionDisconnect=function(a){this._state!==this.IDLE&&this._onDisconnected(this._state,"clean-disconnect")},g.update=function(){if(this._state!==this.JOINED)throw new Error(this.id+": cannot update in unjoined state");this._state=this.UPDATING,this._updatePromise=new d,this._bridge.initiateUpdate().then("_onUpdateSuccess","_onUpdateFailure",this);return this._updatePromise},g._onUpdateSuccess=function(){if(this._state===this.UPDATING){this._state=this.UPDATED;var a=this._updatePromise;this._updatePromise=null,a.resolve()}},g._onUpdateFailure=function(a){if(this._state===this.UPDATING){this.disconnect();var b=this._updatePromise;this._updatePromise=null,b.fail(a)}},g.disconnect=function(b){if(this._state>=this.IDLE){if(this._state===this.IDLE){a.disconnect(b);return}this._state=this.DISCONNECTING,a.disconnect(b),this._state!==this.IDLE&&this._onDisconnected(this._state,"clean-disconnect")}},g._onDisconnected=function(a,b){this._state=this.IDLE,this.disconnectPromise.resolve({state:a,tag:b})};return f}),define("coweb/session/BayeuxSession",["coweb/session/bayeux/SessionBridge","coweb/util/Promise","coweb/util/xhr","coweb/util/lang"],function(a,b,c,d){var e=function(){this._prepParams=null,this._lastPrep=null,this._debug=!1,this._bridge=null,this._listener=null,this._destroying=!1,this._unloadToks={},this._loginUrl=null,this._logoutUrl=null},f=e.prototype;f.init=function(b,c){this._loginUrl=b.loginUrl,this._logoutUrl=b.logoutUrl,this._debug=b.debug,this._listener=c,this._bridge=new a({debug:this._debug,listener:this._listener,adminUrl:b.adminUrl});var d=this,e=function(){d.destroy()};this._unloader=e,window.addEventListener?(window.addEventListener("beforeunload",e,!0),window.addEventListener("unload",e,!0)):window.attachEvent&&(window.attachEvent("onbeforeunload",e),window.attachEvent("onunload",e))},f.destroy=function(){this._destroying||(this._destroying=!0,this.onStatusChange=function(){},this._listener.stop(),this._bridge.destroy(),this._listener=null,this._prepParams=null,this._lastPrep=null,this._bridge=null,window.removeEventListener?(window.removeEventListener("beforeunload",this._unloader,!0),window.removeEventListener("unload",this._unloader,!0)):(window.detachEvent("onbeforeunload",this._unloader),window.detachEvent("onunload",this._unloader)),this._unloader=null)},f.isDebug=function(){return this._debug},f.getLastPrepare=function(){return this._lastPrep},f.leave=function(){var a=this._bridge.getState();a!==this._bridge.UPDATED&&this.onStatusChange("aborting"),this._prepParams=null,this._listener.stop();var c=new b;c.resolve(),this._bridge.disconnect();return c},f.login=function(a,d){if(this._bridge.getState()!==this._bridge.IDLE)throw new Error("login() not valid in current state");var e=new b,f={method:"POST",url:this._loginUrl,body:JSON.stringify({username:a,password:d}),headers:{"Content-Type":"application/json;charset=UTF-8"}};return c.send(f)},f.logout=function(){this.leave();var a=new b,d={method:"GET",url:this._logoutUrl};return c.send(d)},f.prepare=function(a){if(this._bridge.getState()!==this._bridge.IDLE)throw new Error("prepare() not valid in current state");a=a||{};var c={},e=window.location.search.substring(1),f=e.split("&");for(var g=0,h=f.length;g<h;g++){var i=f[g].split("=");c[decodeURIComponent(i[0])]=decodeURIComponent(i[1])}a.collab===undefined&&(a.collab=!0),a.key===undefined&&(c.cowebkey!==undefined?a.key=c.cowebkey:a.key=decodeURI(window.location.host+window.location.pathname+window.location.search)),a.autoJoin===undefined&&(a.autoJoin=!0),a.autoUpdate===undefined&&(a.autoUpdate=!0),this._prepParams=d.clone(a),this._prepParams.promise=new b,this._lastPrep=d.clone(a),this._bridge.prepare(a.key,a.collab).then("_onPrepared","_onPrepareError",this),this._bridge.disconnectPromise.then("_onDisconnected",null,this),this.onStatusChange("preparing");return this._prepParams.promise},f._onPrepared=function(a){this._prepParams.response=JSON.parse(JSON.stringify(a)),this._prepParams.response.phase="prepare";if(this._prepParams.autoJoin)this.join();else{var b=this._prepParams.promise;this._prepParams.promise=null,b.resolve(this._prepParams.response)}},f._onPrepareError=function(a){this.onStatusChange(a.message);var b=this._prepParams.promise;this._prepParams=null,b.fail(a)},f.join=function(){if(this._bridge.getState()!==this._bridge.PREPARED)throw new Error("join() not valid in current state");this.onStatusChange("joining"),this._prepParams.response.phase="join",this._prepParams.promise||(this._prepParams.promise=new b),this._bridge.join().then("_onJoined","_onJoinError",this);return this._prepParams.promise},f._onJoined=function(){if(this._prepParams.autoUpdate)this.update();else{var a=this._prepParams.promise;this._prepParams.promise=null,a.resolve(this._prepParams.response)}},f._onJoinError=function(a){var b=this._prepParams.promise;this._prepParams=null,b.fail(a)},f.update=function(a){if(this._bridge.getState()!==this._bridge.JOINED)throw new Error("update() not valid in current state");this.onStatusChange("updating"),this._prepParams.response.phase="update",this._prepParams.promise||(this._prepParams.promise=new b),this._bridge.update().then("_onUpdated","_onUpdateError",this);return this._prepParams.promise},f._onUpdated=function(){var a=this._prepParams;this._prepParams=null;var b=a.promise,c=a.response;b.resolve(c),this.onStatusChange("ready")},f._onUpdateError=function(a){var b=this._prepParams.promise;this._prepParams=null,b.fail(a)},f._onDisconnected=function(a){var b=a.state,c=a.tag;c&&!this._destroying&&this.onStatusChange(c),this._listener.stop(!0),this._prepParams&&!this._prepParams.promise&&(this._prepParams=null)},f.onStatusChange=function(a){};return e}),define("coweb/topics",["require","exports","module"],function(){var a="coweb.";return{PREFIX:a,SUB_SERVICE:a+"service.sub.",GET_SERVICE:a+"service.get.",UNSUB_SERVICE:a+"service.unsub.",SET_SERVICE:a+"service.response.",SYNC:a+"sync.",GET_STATE:a+"state.get",SET_STATE:a+"state.set.",ENGINE_STATE:a+"engine.state",ENGINE_SYNC:a+"engine.sync",SITE_JOIN:a+"site.join",SITE_LEAVE:a+"site.leave",READY:a+"site.ready",END:a+"site.end",BUSY:a+"busy.change"}}),define("coweb/jsoe/factory",["require","exports","module"],function(){var a={};return{createHistoryKey:function(a,b){return a+","+b},registerOperationForType:function(b,c){a[b]=c},createOperationFromType:function(b,c){var d=a[b];return new d(c)},createOperationFromState:function(b){var c=a[b[0]];return new c({state:b})}}}),define("coweb/jsoe/ContextDifference",["coweb/jsoe/factory"],function(a){var b=function(){this.sites=[],this.seqs=[]};b.prototype.addRange=function(a,b,c){for(var d=b;d<c;d++)this.addSiteSeq(a,d)},b.prototype.addSiteSeq=function(a,b){this.sites.push(a),this.seqs.push(b)},b.prototype.getHistoryBufferKeys=function(){var b=[];for(var c=0,d=this.seqs.length;c<d;c++){var e=a.createHistoryKey(this.sites[c],this.seqs[c]);b.push(e)}return b},b.prototype.toString=function(){return this.getHistoryBufferKeys().toString()};return b}),define("coweb/jsoe/ContextVector",["coweb/jsoe/ContextDifference"],function(a){var b=function(a){if(typeof a.count!=="undefined")this.sites=[],this.growTo(a.count);else if(a.contextVector)this.sites=a.contextVector.copySites();else if(a.sites)this.sites=a.sites.slice();else if(a.state)this.sites=a.state;else throw new Error("uninitialized context vector")};b.prototype.toString=function(){return"["+this.sites.toString()+"]"},b.prototype.getState=function(){return this.sites},b.prototype.copy=function(){return new b({contextVector:this})},b.prototype.copySites=function(){return this.sites.slice()},b.prototype.subtract=function(b){var c=new a;for(var d=0;d<this.sites.length;d++){var e=this.getSeqForSite(d),f=b.getSeqForSite(d);e-f>0&&c.addRange(d,f+1,e+1)}return c},b.prototype.oldestDifference=function(b){var c=new a;for(var d=0;d<this.sites.length;d++){var e=this.getSeqForSite(d),f=b.getSeqForSite(d);e-f>0&&c.addSiteSeq(d,f+1)}return c},b.prototype.growTo=function(a){for(var b=this.sites.length;b<a;b++)this.sites.push(0)},b.prototype.getSeqForSite=function(a){this.sites.length<=a&&this.growTo(a+1);return this.sites[a]},b.prototype.setSeqForSite=function(a,b){this.sites.length<=a&&this.growTo(a+1),this.sites[a]=b},b.prototype.getSize=function(){return this.sites.length},b.prototype.equals=function(a){var b=this.sites,c=a.sites,d=Math.max(b.length,c.length);for(var e=0;e<d;e++){var f=e<b.length?b[e]:0,g=e<c.length?c[e]:0;if(f!==g)return!1}return!0},b.prototype.compare=function(a){var b=this.sites,c=a.sites,d=Math.max(b.length,c.length);for(var e=0;e<d;e++){var f=e<b.length?b[e]:0,g=e<c.length?c[e]:0;if(f<g)return-1;if(f>g)return 1}return 0};return b}),define("coweb/jsoe/ContextVectorTable",["coweb/jsoe/ContextVector"],function(a){var b=function(a,b){this.cvt=[],this.growTo(b+1),this.cvt[b]=a};b.prototype.toString=function(){var a=[];for(var b=0,c=this.cvt.length;b++;b<c){var d=this.cvt[b];a[b]=d.toString()}return a.toString()},b.prototype.getEquivalents=function(a,b){var c=[];for(var d=0,e=this.cvt.length;d<e;d++)d!==b&&this.cvt[d]===a&&c.push(d);return c},b.prototype.getState=function(){var a=[];for(var b=0,c=this.cvt.length;b<c;b++)a[b]=this.cvt[b].getState();return a},b.prototype.setState=function(b){this.cvt=[];for(var c=0,d=b.length;c<d;c++)this.cvt[c]=new a({state:b[c]})},b.prototype.growTo=function(b){for(var c=0,d=this.cvt.length;c<d;c++)this.cvt[c].growTo(b);for(c=this.cvt.length;c<b;c++){var e=new a({count:b});this.cvt.push(e)}},b.prototype.getContextVector=function(a){this.cvt.length<=a&&this.growTo(a+1);return this.cvt[a]},b.prototype.updateWithContextVector=function(a,b){this.cvt.length<=a&&this.growTo(a+1),b.getSize()<=a&&b.growTo(a+1),this.cvt[a]=b},b.prototype.updateWithOperation=function(a){var b=a.contextVector.copy();b.setSeqForSite(a.siteId,a.seqId),this.updateWithContextVector(a.siteId,b)},b.prototype.getMinimumContextVector=function(){if(!this.cvt.length)return null;var a=this.cvt[0].copy();for(var b=1,c=this.cvt.length;b<c;b++){var d=this.cvt[b];for(var e=0;e<c;e++){var f=d.getSeqForSite(e),g=a.getSeqForSite(e);f<g&&a.setSeqForSite(e,f)}}return a};return b}),define("coweb/jsoe/Operation",["coweb/jsoe/ContextVector"],function(a){var b=function(a){if(a===undefined)this.type=null;else{if(a.state)this.setState(a.state),this.local=!1;else{this.siteId=a.siteId,this.contextVector=a.contextVector,this.key=a.key,this.value=a.value,this.position=a.position,this.order=a.order||Infinity;if(a.seqId!==undefined)this.seqId=a.seqId;else if(this.contextVector)this.seqId=this.contextVector.getSeqForSite(this.siteId)+1;else throw new Error("missing sequence id for new operation");this.xCache=a.xCache,this.local=a.local||!1}this.immutable=!1,this.xCache||(this.xCache=[]),this.immutable=!1}};b.prototype.getState=function(){var a=[this.type,this.key,this.value,this.position,this.contextVector.sites,this.seqId,this.siteId,this.order];return a},b.prototype.setState=function(b){if(b[0]!==this.type)throw new Error("setState invoked with state from wrong op type");if(this.immutable)throw new Error("op is immutable");this.key=b[1],this.value=b[2],this.position=b[3],this.contextVector=new a({state:b[4]}),this.seqId=b[5],this.siteId=b[6],this.order=b[7]||Infinity},b.prototype.copy=function(){var a={siteId:this.siteId,seqId:this.seqId,contextVector:this.contextVector.copy(),key:this.key,value:this.value,position:this.position,order:this.order,local:this.local,xCache:this.xCache},b=new this.constructor(a);return b},b.prototype.getFromCache=function(a){var b=this.xCache,c,d,e;for(d=0,e=b.length;d<e;d++){c=b[d];if(c.contextVector.equals(a))return c.copy()}return null},b.prototype.addToCache=function(a){var b=this.xCache,c=this.copy();c.immutable=!0,b.push(c);var d=b.length-(a-1);d>0&&(b=b.slice(d))},b.prototype.compareByContext=function(a){var b=this.contextVector.compare(a.contextVector);if(b===0)return this.siteId<a.siteId?-1:this.siteId>a.siteId?1:0;return b},b.prototype.compareByOrder=function(a){if(this.order===a.order){if(this.local===a.local)return this.seqId<a.seqId?-1:1;if(this.local&&!a.local)return 1;if(!this.local&&a.local)return-1}else{if(this.order<a.order)return-1;if(this.order>a.order)return 1}},b.prototype.transformWith=function(a){if(this.immutable)throw new Error("attempt to transform immutable op");var b=this[a.transformMethod()],c;if(!b)throw new Error("operation cannot handle transform with type: "+a.type);c=b.apply(this,arguments),c&&this.upgradeContextTo(a);return c},b.prototype.upgradeContextTo=function(a){if(this.immutable)throw new Error("attempt to upgrade context of immutable op");this.contextVector.setSeqForSite(a.siteId,a.seqId)},b.prototype.getTransformMethod=function(){throw new Error("transformMethod not implemented")};return b}),define("coweb/jsoe/HistoryBuffer",["coweb/jsoe/factory","coweb/jsoe/Operation"],function(a,b){var c=function(){this.ops={},this.size=0};c.prototype.getState=function(){var a=[],b=0;for(var c in this.ops)this.ops.hasOwnProperty(c)&&(a[b]=this.ops[c].getState(),++b);return a},c.prototype.setState=function(b){this.size=0,this.ops={};for(var c=0;c<b.length;c++){var d=a.createOperationFromState(b[c]);this.addLocal(d)}},c.prototype.getOpsForDifference=function(a){var b=a.getHistoryBufferKeys(),c=[];for(var d=0,e=b.length;d<e;d++){var f=b[d],g=this.ops[f];if(g===undefined)throw new Error("missing op for context diff: i="+d+" key="+f+" keys="+b.toString());c.push(g)}c.sort(function(a,b){return a.compareByOrder(b)});return c},c.prototype.addLocal=function(b){var c=a.createHistoryKey(b.siteId,b.seqId);this.ops[c]=b,b.immutable=!0,++this.size},c.prototype.addRemote=function(b){var c=a.createHistoryKey(b.siteId,b.seqId),d=this.ops[c];if(b.order===null||b.order===undefined||b.order===Infinity)throw new Error("remote op missing total order");if(d){if(d.order!==Infinity)throw new Error("duplicate op in total order: old="+d.order+" new="+b.order);d.order=b.order}else this.ops[c]=b,b.immutable=!0,++this.size},c.prototype.remove=function(b){var c=a.createHistoryKey(b.siteId,b.seqId);b=this.ops[c],delete this.ops[c],b.immutable=!1,--this.size;return b},c.prototype.getCount=function(){return this.size},c.prototype.getContextSortedOperations=function(){var a=[];for(var b in this.ops)this.ops.hasOwnProperty(b)&&a.push(this.ops[b]);a.sort(function(a,b){return a.compareByContext(b)});return a};return c}),define("coweb/jsoe/UpdateOperation",["coweb/jsoe/Operation","coweb/jsoe/factory"],function(a,b){var c=function(b){this.type="update",a.call(this,b)};c.prototype=new a,c.prototype.constructor=c,b.registerOperationForType("update",c),c.prototype.transformMethod=function(){return"transformWithUpdate"},c.prototype.transformWithUpdate=function(a){if(a.position!==this.position||a.key!==this.key)return this;this.siteId>a.siteId?this.value=a.value:this.siteId===a.siteId&&this.seqId<a.seqId&&(this.value=a.value);return this},c.prototype.transformWithInsert=function(a){if(this.key!==a.key)return this;this.position>=a.position&&++this.position;return this},c.prototype.transformWithDelete=function(a){if(this.key!==a.key)return this;if(this.position>a.position)--this.position;else if(this.position===a.position)return null;return this};return c}),define("coweb/jsoe/InsertOperation",["coweb/jsoe/Operation","coweb/jsoe/factory"],function(a,b){var c=function(b){this.type="insert",a.call(this,b)};c.prototype=new a,c.prototype.constructor=c,b.registerOperationForType("insert",c),c.prototype.transformMethod=function(){return"transformWithInsert"},c.prototype.transformWithUpdate=function(a){return this},c.prototype.transformWithInsert=function(a){if(this.key!==a.key)return this;(this.position>a.position||this.position===a.position&&this.siteId<=a.siteId)&&++this.position;return this},c.prototype.transformWithDelete=function(a){if(this.key!==a.key)return this;this.position>a.position&&--this.position;return this};return c}),define("coweb/jsoe/DeleteOperation",["coweb/jsoe/Operation","coweb/jsoe/factory"],function(a,b){var c=function(b){this.type="delete",a.call(this,b)};c.prototype=new a,c.prototype.constructor=c,b.registerOperationForType("delete",c),c.prototype.transformMethod=function(){return"transformWithDelete"},c.prototype.transformWithUpdate=function(a){return this},c.prototype.transformWithInsert=function(a){if(this.key!==a.key)return this;this.position>=a.position&&++this.position;return this},c.prototype.transformWithDelete=function(a){if(this.key!==a.key)return this;if(this.position>a.position)--this.position;else if(this.position===a.position)return null;return this};return c}),define("coweb/jsoe/OperationEngine",["coweb/jsoe/ContextVectorTable","coweb/jsoe/ContextVector","coweb/jsoe/HistoryBuffer","coweb/jsoe/factory","coweb/jsoe/UpdateOperation","coweb/jsoe/InsertOperation","coweb/jsoe/DeleteOperation"],function(a,b,c,d){var e=function(d){this.siteId=d,this.cv=new b({count:d+1}),this.cvt=new a(this.cv,d),this.hb=new c,this.siteCount=1};e.prototype.getState=function(){var a=this.cvt.getEquivalents(this.cv,this.siteId);return[this.cvt.getState(),this.hb.getState(),this.siteId,a]},e.prototype.setState=function(a){this.cvt.setState(a[0]),this.hb.setState(a[1]),this.cv=this.cvt.getContextVector(a[2]),this.cv=this.cv.copy(),this.cvt.updateWithContextVector(this.siteId,this.cv),this.siteCount=this.cv.getSize();var b=a[3];for(var c=0,d=b.length;c<d;c++)this.freezeSite(b[c])},e.prototype.copyContextVector=function(){return this.cv.copy()},e.prototype.createOp=function(a,c,e,f,g,h,i,j){var k;a?k={key:c,position:g,value:e,siteId:this.siteId,contextVector:this.copyContextVector(),local:!0}:(i=new b({sites:i}),k={key:c,position:g,value:e,siteId:h,contextVector:i,order:j,local:!1});return d.createOperationFromType(f,k)},e.prototype.push=function(a){var b=this.createOp.apply(this,arguments);return a?this.pushLocalOp(b):this.pushRemoteOp(b)},e.prototype.pushLocalOp=function(a){this.cv.setSeqForSite(a.siteId,a.seqId),this.hb.addLocal(a);return a},e.prototype.pushRemoteOp=function(a){var b=null;if(this.hasProcessedOp(a)){this.hb.addRemote(a);return null}if(this.cv.equals(a.contextVector))b=a.copy();else{var c=this.cv.subtract(a.contextVector);a.immutable=!0,b=this._transform(a,c)}this.cv.setSeqForSite(a.siteId,a.seqId),this.hb.addRemote(a),this.cvt.updateWithOperation(a);return b},e.prototype.pushSync=function(a,b){this.cvt.updateWithContextVector(a,b)},e.prototype.pushSyncWithSites=function(a,c){var d=new b({state:c});this.pushSync(a,d)},e.prototype.purge=function(){if(this.getBufferSize()===0)return null;var a=this.cvt.getMinimumContextVector();if(a===null)return null;var b,c=this.cv.oldestDifference(a),d=this.hb.getOpsForDifference(c);while(d.length){var e=d.pop();if(b===undefined||e.compareByContext(b)===-1)c=this.cv.oldestDifference(e.contextVector),d=d.concat(this.hb.getOpsForDifference(c)),b=e}d=this.hb.getContextSortedOperations();for(var f=0;f<d.length;f++){var g=d[f];if(b===undefined||(b.siteId!==g.siteId||b.seqId!==g.seqId))this.hb.remove(g);else break}return a},e.prototype.getBufferSize=function(){return this.hb.getCount()},e.prototype.hasProcessedOp=function(a){var b=this.cv.getSeqForSite(a.siteId);return b>=a.seqId},e.prototype.freezeSite=function(a){this.cvt.getContextVector(a)!==this.cv&&(this.cvt.updateWithContextVector(a,this.cv),this.siteCount--)},e.prototype.thawSite=function(a){if(a!==this.siteId){var b=this.cvt.getMinimumContextVector();b.growTo(a),this.cvt.updateWithContextVector(a,b),this.siteCount++}},e.prototype.getSiteCount=function(){return this.siteCount},e.prototype._transform=function(a,b){var c=this.hb.getOpsForDifference(b),d,e,f,g,h,i;a=a.copy();for(h=0,i=c.length;h<i;h++){e=c[h];if(!a.contextVector.equals(e.contextVector)){f=e.getFromCache(a.contextVector);if(f)e=f;else{d=a.contextVector.subtract(e.contextVector);if(!d.sites.length)throw new Error("transform produced empty context diff");f=this._transform(e,d);if(f===null){a.upgradeContextTo(e);continue}e=f}}if(!a.contextVector.equals(e.contextVector))throw new Error("context vectors unequal after upgrade");g=a.copy(),a=a.transformWith(e);if(a===null)return null;a.addToCache(this.siteCount),e=e.copy(),e=e.transformWith(g),e&&e.addToCache(this.siteCount)}return a};return e}),define("org/OpenAjax",["require","exports","module"],function(){window.OpenAjax||(OpenAjax=new function(){var a=!0,b=!1,c=window,d,e="org.openajax.hub.",f={};this.hub=f,f.implementer="http://openajax.org",f.implVersion="1.0",f.specVersion="1.0",f.implExtraData={};var d={};f.libraries=d,f.registerLibrary=function(a,b,c,f){d[a]={prefix:a,namespaceURI:b,version:c,extraData:f},this.publish(e+"registerLibrary",d[a])},f.unregisterLibrary=function(a){this.publish(e+"unregisterLibrary",d[a]),delete d[a]},f._subscriptions={c:{},s:[]},f._cleanup=[],f._subIndex=0,f._pubDepth=0,f.subscribe=function(a,b,c,d,e){c||(c=window);var f=a+"."+this._subIndex,g={scope:c,cb:b,fcb:e,data:d,sid:this._subIndex++,hdl:f},h=a.split(".");this._subscribe(this._subscriptions,h,0,g);return f},f.publish=function(a,b){var c=a.split(".");this._pubDepth++,this._publish(this._subscriptions,c,0,a,b),this._pubDepth--;if(this._cleanup.length>0&&this._pubDepth==0){for(var d=0;d<this._cleanup.length;d++)this.unsubscribe(this._cleanup[d].hdl);delete this._cleanup,this._cleanup=[]}},f.unsubscribe=function(a){var b=a.split("."),c=b.pop();this._unsubscribe(this._subscriptions,b,0,c)},f._subscribe=function(a,b,c,d){var e=b[c];c==b.length?a.s.push(d):(typeof a.c=="undefined"&&(a.c={}),typeof a.c[e]=="undefined"?(a.c[e]={c:{},s:[]},this._subscribe(a.c[e],b,c+1,d)):this._subscribe(a.c[e],b,c+1,d))},f._publish=function(a,b,c,d,e){if(typeof a!="undefined"){var f;c==b.length?f=a:(this._publish(a.c[b[c]],b,c+1,d,e),this._publish(a.c["*"],b,c+1,d,e),f=a.c["**"]);if(typeof f!="undefined"){var g=f.s,h=g.length;for(var i=0;i<h;i++)if(g[i].cb){var j=g[i].scope,k=g[i].cb,l=g[i].fcb,m=g[i].data;typeof k=="string"&&(k=j[k]),typeof l=="string"&&(l=j[l]),(!l||l.call(j,d,e,m))&&k.call(j,d,e,m)}}}},f._unsubscribe=function(a,b,c,d){if(typeof a!="undefined"){if(c<b.length){var e=a.c[b[c]];this._unsubscribe(e,b,c+1,d);if(e.s.length==0){for(var f in e.c)return;delete a.c[b[c]]}return}var g=a.s,h=g.length;for(var i=0;i<h;i++)if(d==g[i].sid){this._pubDepth>0?(g[i].cb=null,this._cleanup.push(g[i])):g.splice(i,1);return}}},f.reinit=function(){for(var a in OpenAjax.hub.libraries)delete OpenAjax.hub.libraries[a];OpenAjax.hub.registerLibrary("OpenAjax","http://openajax.org/hub","1.0",{}),delete OpenAjax._subscriptions,OpenAjax._subscriptions={c:{},s:[]},delete OpenAjax._cleanup,OpenAjax._cleanup=[],OpenAjax._subIndex=0,OpenAjax._pubDepth=0}},OpenAjax.hub.registerLibrary("OpenAjax","http://openajax.org/hub","1.0",{}));return OpenAjax}),define("coweb/listener/UnmanagedHubListener",["coweb/topics","coweb/jsoe/OperationEngine","org/OpenAjax"],function(a,b,c){var d=1e4,e=1e4,f=function(){this._mutex=!1,this._engine=null,this._shouldPurge=!1,this._shouldSync=!1,this._syncTimer=null,this._purgeTimer=null,this._bridge=null,this._collab=!1,this._conns=[]},g=f.prototype;g.start=function(b,f){this._bridge=b,this._subscribeHub(f.collab);if(f.collab){this._syncTimer&&clearInterval(this._syncTimer),this._purgeTimer&&clearInterval(this._purgeTimer);var g=this;this._syncTimer=setInterval(function(){g._engineSyncOutbound()},d),this._purgeTimer=setInterval(function(){g._onPurgeEngine()},e)}var h=this._bridge.getInitialRoster(),i={username:f.username,site:this._engine.siteId,roster:h};c.hub.publish(a.READY,i)},g.stop=function(b){if(this._bridge)try{var d={connected:!b};c.hub.publish(a.END,d)}catch(e){console.warn("UnmanagedHubListener: failed end session notice "+e.message)}this._bridge=null,this._syncTimer&&(clearInterval(this._syncTimer),this._syncTimer=null),this._purgeTimer&&(clearInterval(this._purgeTimer),this._purgeTimer=null),this._unsubscribeHub()},g._subscribeHub=function(b){var d;b&&(d=c.hub.subscribe(a.SYNC+"**","_syncOutbound",this),this._conns.push(d),d=c.hub.subscribe(a.SET_STATE+"**","_stateOutbound",this),this._conns.push(d)),d=c.hub.subscribe(a.SUB_SERVICE+"**","_onSubServiceOutbound",this),this._conns.push(d),d=c.hub.subscribe(a.UNSUB_SERVICE+"**","_onUnsubServiceOutbound",this),this._conns.push(d),d=c.hub.subscribe(a.GET_SERVICE+"**","_onRequestServiceOutbound",this),this._conns.push(d)},g._unsubscribeHub=function(){for(var a=0,b=this._conns.length;a<b;a++)c.hub.unsubscribe(this._conns[a]);this._conns=[]},g.setSiteID=function(a){this._engine=new b(a),this._engine.freezeSite(0)},g.syncInbound=function(a,b,d,e,f,g,h){var i,j;if(g&&d){try{i=this._engine.push(!1,a,b,d,e,f,g,h)}catch(k){console.warn("UnmanagedHubListener: failed to push op into engine "+k.message);return}if(i===null)return;b=i.value,e=i.position}else if(f===this._engine.siteId)return;j={position:e,type:d,value:JSON.parse(b),site:f},this._mutex=!0;try{c.hub.publish(a,j)}catch(l){console.warn("UnmanagedHubListener: failed to deliver incoming event "+a+"("+l.message+")")}this._mutex=!1,i&&(this._shouldPurge=!0,this._shouldSync=!0)},g._syncOutbound=function(a,b){if(!this._mutex&&this._engine){var c=b.position,d=b.type,e=JSON.stringify(b.value),f=null,g=null,h,i,j;if(d!==null)try{f=this._engine.createOp(!0,a,e,d,c),g=f.contextVector.sites}catch(k){console.warn('UnmanagedHubListener: bad type "'+d+'" on outgoing event; making null'),d=null}try{i=this._bridge.postSync(a,e,d,c,g)}catch(l){j=l,i=!1,console.warn("UnmanagedHubListener: failed to send hub event "+l.message)}if(i&&d!==null)this._engine.pushLocalOp(f),this._shouldPurge=!0;else if(j)throw j}},g.noticeInbound=function(b,d){var e,f={};f.site=d.siteId,f.username=d.username;if(b==="available"){e=a.SITE_JOIN;try{this._engine.thawSite(f.site)}catch(g){console.warn("UnmanagedHubListener: failed to thaw site "+f.site+" "+g.message)}}else if(b==="unavailable"){e=a.SITE_LEAVE;try{this._engine.freezeSite(f.site)}catch(h){console.warn("UnmanagedHubListener: failed to freeze site "+f.site+" "+h.message)}}this._mutex=!0;try{c.hub.publish(e,f)}catch(i){console.warn("UnmanagedHubListener: failed to deliver notice "+i.message)}this._mutex=!1},g.servicePublishInbound=function(b,d,e){var f=a.SET_SERVICE+b,g={value:d,error:e};try{c.hub.publish(f,g)}catch(h){console.warn("UnmanagedHubListener: failed to deliver bot publish "+h.message)}},g.serviceResponseInbound=function(a,b,d){var e={value:b,error:d};try{c.hub.publish(a,e)}catch(f){console.warn("UnmanagedHubListener: failed to deliver bot response "+f.message)}},g._onSubServiceOutbound=function(a,b){try{this._bridge.postServiceSubscribe(b.service)}catch(c){console.warn("UnmanagedHubListener: failed service subscribe "+c.message)}},g._onUnsubServiceOutbound=function(a,b){try{this._bridge.postServiceUnsubscribe(b.service)}catch(c){console.warn("UnmanagedHubListener: failed service unsub "+c.message)}},g._onRequestServiceOutbound=function(a,b){try{this._bridge.postServiceRequest(b.service,b.params,b.topic)}catch(c){console.warn("UnmanagedHubListener: failed service request "+c.message)}},g.requestStateInbound=function(b){try{c.hub.publish(a.GET_STATE,b)}catch(d){console.warn("UnmanagedHubListener: failed collecting state "+d.message)}var e;try{this._engine.purge(),e=this._engine.getState()}catch(f){console.warn("UnmanagedHubListener: failed collecting engine state "+f.message)}try{this._bridge.postStateResponse(a.ENGINE_STATE,e,b)}catch(g){console.warn("UnmanagedHubListener: failed sending engine state "+g.message)}try{this._bridge.postStateResponse(null,null,b)}catch(h){console.warn("UnmanagedHubListener: failed sending end state "+h.message)}},g._stateOutbound=function(a,b){if(!this._mutex){var c=b.recipient,d=b.state;try{this._bridge.postStateResponse(a,d,c)}catch(e){console.warn("UnmanagedHubListener: failed to send state "+e.message)}}},g.stateInbound=function(b,d){if(b===a.ENGINE_STATE)try{this._engine.setState(d)}catch(e){console.warn("UnmanagedHubListener: failed to recv engine state "+e.message);throw e}else{this._mutex=!0;try{c.hub.publish(b,d)}catch(f){console.warn("UnmanagedHubListener: failed to recv state "+f.message);throw f}finally{this._mutex=!1}}},g._engineSyncOutbound=function(){if(this._engine&&this._shouldSync){var a=this._engine.copyContextVector();try{this._bridge.postEngineSync(a.sites)}catch(b){console.warn("UnmanagedHubListener: failed to send engine sync "+b.message);return}this._shouldSync=!1}},g.engineSyncInbound=function(a,b){if(a!==this._engine.siteId){try{this._engine.pushSyncWithSites(a,b)}catch(c){console.warn("UnmanagedHubListener: failed to recv engine sync "+a+" "+b+" "+c.message)}this._shouldPurge=!0}},g._onPurgeEngine=function(){if(this._engine){var a;if(this._shouldPurge){a=this._engine.getBufferSize();try{var b=this._engine.purge()}catch(c){console.warn("UnmanagedHubListener: failed to purge engine "+c.message)}}this._shouldPurge=!1;return a}};return f}),define("coweb/collab/UnmanagedHubCollab",["coweb/topics","coweb/util/Promise","org/OpenAjax"],function(a,b,c){var d=function(){this._mutex=!1,this._serviceId=0,this._tokens={},this.id=undefined},e=d.prototype;e.init=function(a){if(!a||a.id===undefined)throw new Error("collab id required");this.id=a.id},e.subscribeReady=function(d,e){e===undefined&&(e=d,d=this);if(typeof e!=="function"){e=d[e];if(typeof e!=="function")throw new Error("callback must be a function")}var f=a.READY,g=c.hub.subscribe(f,function(a,b){e.call(d,b)},this);this._tokens[g]=null;var h=new b;h._cowebToken=g,h.resolve();return h},e.subscribeEnd=function(d,e){e===undefined&&(e=d,d=this);if(typeof e!=="function"){e=d[e];if(typeof e!=="function")throw new Error("callback must be a function")}var f=a.END,g=c.hub.subscribe(f,function(a,b){e.call(d,b)},this);this._tokens[g]=null;var h=new b;h._cowebToken=g,h.resolve();return h},e.subscribeSiteJoin=function(d,e){e===undefined&&(e=d,d=this);if(typeof e!=="function"){e=d[e];if(typeof e!=="function")throw new Error("callback must be a function")}var f=a.SITE_JOIN,g=c.hub.subscribe(f,function(a,b){e.call(d,b)},this);this._tokens[g]=null;var h=new b;h._cowebToken=g,h.resolve();return h},e.subscribeSiteLeave=function(d,e){e===undefined&&(e=d,d=this);if(typeof e!=="function"){e=d[e];if(typeof e!=="function")throw new Error("callback must be a function")}var f=a.SITE_LEAVE,g=c.hub.subscribe(f,function(a,b){e.call(d,b)},this);this._tokens[g]=null;var h=new b;h._cowebToken=g,h.resolve();return h},e.sendSync=function(b,d,e,f){if(this.id===undefined)throw new Error("call init() first");e===undefined&&(e="update"),f===undefined&&(f=0);var g=a.SYNC+b+"."+this.id,h={value:d,type:e,position:f};this._mutex=!0,c.hub.publish(g,h),this._mutex=!1},e.subscribeSync=function(d,e,f){if(this.id===undefined)throw new Error("call init() first");if(!d)throw new Error("valid sync name required");f===undefined&&(f=e,e=this);if(typeof f!=="function"){f=e[f];if(typeof f!=="function")throw new Error("callback must be a function")}var g=a.SYNC+d+"."+this.id,h=a.SYNC.length,i=this.id.length+1,j=c.hub.subscribe(g,function(a,b){this._mutex||(b.name=a.substring(h,a.length-i),b.topic=a,f.call(e,b))},this);this._tokens[j]=null;var k=new b;k._cowebToken=j,k.resolve();return k},e.subscribeStateRequest=function(d,e){e===undefined&&(e=d,d=this);if(typeof e!=="function"){e=d[e];if(typeof e!=="function")throw new Error("callback must be a function")}var f=a.GET_STATE,g=c.hub.subscribe(f,function(a,b){e.call(d,b)},this);this._tokens[g]=null;var h=new b;h._cowebToken=g,h.resolve();return h},e.sendStateResponse=function(b,d){if(this.id===undefined)throw new Error("call init() first");var e={state:b,recipient:d};this._mutex=!0;try{c.hub.publish(a.SET_STATE+this.id,e)}finally{this._mutex=!1}},e.subscribeStateResponse=function(d,e){if(this.id===undefined)throw new Error("call init() first");e===undefined&&(e=d,d=this);if(typeof e!=="function"){e=d[e];if(typeof e!=="function")throw new Error("callback must be a function")}var f=a.SET_STATE+this.id,g=c.hub.subscribe(f,function(a,b){this._mutex||e.call(d,b)},this);this._tokens[g]=null;var h=new b;h._cowebToken=g,h.resolve();return h},e.subscribeService=function(d,e,f){f===undefined&&(f=e,e=this);if(typeof f!=="function"){f=e[f];if(typeof f!=="function")throw new Error("callback must be a function")}var g=a.SET_SERVICE+d,h={callback:f,context:e,type:"subscribe"},i=c.hub.subscribe(g,"_cowebServiceResponse",this,h),j={topic:g,service:d},k=a.SUB_SERVICE+d;c.hub.publish(k,j);var l={topic:g,service:d,hubToken:i};this._tokens[i]=l;var m=new b;m.resolve(),m._cowebToken=l;return m},e.postService=function(d,e,f,g){if(this.id===undefined)throw new Error("call init() first");g===undefined&&(g=f,f=this);if(typeof g!=="function"){g=f[g];if(typeof g!=="function")throw new Error("callback must be a function")}var h=a.SET_SERVICE+d+"_"+this._serviceId+"."+this.id,i={context:f,callback:g,type:"get"},j=c.hub.subscribe(h,"_cowebServiceResponse",this,i);this._tokens[j]=null,i.hubToken=j;var k={topic:h,params:e,service:d},l=a.GET_SERVICE+d;c.hub.publish(l,k),this._serviceId++;var m=new b;m.resolve(),m._cowebToken=j;return m},e._cowebServiceResponse=function(a,b,d){var e=d.hubToken,f={value:b.value,error:b.error};try{d.callback.call(d.context,f)}finally{d.type==="get"&&(c.hub.unsubscribe(d.hubToken),delete this._tokens[e])}},e.unsubscribe=function(b){var d,e;if(b)if(b._cowebToken&&b._cowebToken.hubToken){d=b._cowebToken,delete b._cowebToken,c.hub.unsubscribe(d.hubToken),delete this._tokens[d.hubToken];var f=a.UNSUB_SERVICE+d.service;c.hub.publish(f,d)}else b._cowebToken&&(d=b._cowebToken,delete b._cowebToken,delete this._tokens[d],c.hub.unsubscribe(d))},e.unsubscribeAll=function(){for(var b in this._tokens)if(this._tokens.hasOwnProperty(b)){var d=this._tokens[b];c.hub.unsubscribe(b),delete this._tokens[b];if(d){var e=a.UNSUB_SERVICE+d.service;c.hub.publish(e,d)}}};return d})